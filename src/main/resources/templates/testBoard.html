<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

    <div id="boardBox" style="width: 500px; display: inline-block">
        <div id="boardBox1">

        </div>
        <div id="boardBox2">
            <input type="button" id="write" value="글쓰기" onclick="writeBoard()">
        </div>
    </div>
    <div id="contentBox" style="width: 500px; display: inline-block">

    </div>

  <script>
      function viewMain(){
          const message = {
              type: "view"
          }
          socket.send(JSON.stringify(message));
      }
      function viewContent(number){
          const message = {
              type: "viewContent",
              number: number
          }
          socket.send(JSON.stringify(message));
      }
    const socket = new WebSocket("ws://210.117.31.169/testBoardMain");
    socket.onopen = function(event) {
        console.log("WebSocket 연결 성공!");
        viewMain();
    };

    socket.onmessage = function(event) {
        console.log("서버로부터 받은 메시지:", event.data);
        const boardList = JSON.parse(event.data);
        if(!Array.isArray(boardList)){
            document.getElementById("contentBox").innerHTML = `
            `;
            document.getElementById("contentBox").innerHTML = `
            <div>
                글쓴이 : ${boardList.author}
            </div>
            <div>
                제목 : ${boardList.title}
            </div>
            <div>
                등록일 : ${boardList.regDate}
            </div>
            <div>
                내용 : ${boardList.content}
            </div>
            `;
            if(boardList.imageFile != null){
                document.getElementById("contentBox").innerHTML += `
            <div>
                <img src="/${boardList.imageFile}" style="width: 300px;">
            </div>
            <div>
                <a href="/${boardList.imageFile}" target="_blank">크게보기</a>
            </div>`
            }
        }else{
            document.getElementById("boardBox1").innerHTML = "<div><hr></div>";
            for(let i = boardList.length-1; i >= 0; i--){
                document.getElementById("boardBox1").innerHTML += `
            <div onclick="viewContent(${i})">
                글쓴이 : ${boardList[i].author}<br>
                제목 : ${boardList[i].title}
            </div>
            <hr>
            `;
            }
        }


    };

    socket.onclose = function(event) {
        window.location.href = '/testLogin'
        console.log("WebSocket 연결 종료:", event);
    };

    socket.onerror = function(error) {
        window.location.href = '/testLogin'
        console.error("WebSocket 에러:", error);
    };
    function writeBoard(){
        document.getElementById("contentBox").innerHTML = `
    <input type="text" placeholder="제목" style="width: 300px;" id="boardTitle"><br>
    <textarea placeholder="내용" width="300px" style="width: 300px; height: 200px;" id="boardContent"></textarea><br>
    <input type="file" id="boardFile"><br>
    <input type="button" value="등록" onclick="writeBoard2()">
    <input type="button" value="닫기" onclick="closeWrite()">
`;
    }
    function closeWrite(){
        document.getElementById("contentBox").innerHTML = "";
    }

    function writeBoard2(){
        const title = document.getElementById("boardTitle").value;
        const content = document.getElementById("boardContent").value;
        const file = document.getElementById("boardFile").files[0];
        let imageFile = "x";
        // console.log(title);
        // console.log(content);
        // console.log(file.files[0].name);
        if(file){
            const formData = new FormData;
            formData.append('file', file);

            fetch('/tBoard/upload',{
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(data =>{
                    imageFile = data
                    const message = {
                        type: "write",
                        title: title,
                        content: content,
                        imageFile: imageFile
                    }
                    socket.send(JSON.stringify(message));
                })
                .catch(error =>{
                    console.error('Error:', error)
                })

        }else {
            const message = {
                type: "write",
                title: title,
                content: content,
                imageFile: imageFile
            }
            socket.send(JSON.stringify(message));
        }

        closeWrite();
    }
  </script>
</body>
</html>